{% extends "base.html" %}

{% block title %}Admin - Print Queue Manager{% endblock %}

{% block content %}
<div class="nav-tabs">
    <a href="{{ url_for('dashboard') }}" class="nav-tab">My Jobs</a>
    <a href="{{ url_for('admin') }}" class="nav-tab active">All Jobs (Admin)</a>
</div>

<div class="status-bar">
    <div class="status-indicator">
        <div class="status-dot online"></div>
        <span>Printer Online</span>
    </div>
    <div>
        <span id="job-count">{{ jobs|length }} job(s) in queue</span>
    </div>
</div>

<h2 style="margin-bottom: 20px;">All Print Jobs (Admin View)</h2>

{% if jobs %}
<table id="jobs-table">
    <thead>
        <tr>
            <th>Job ID</th>
            <th>User</th>
            <th>Document Name</th>
            <th>Status</th>
            <th>Pages</th>
            <th>Size</th>
            <th>Submitted</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for job in jobs %}
        <tr data-job-id="{{ job.id }}">
            <td><strong>#{{ job.id }}</strong></td>
            <td>{{ job.user }}</td>
            <td>{{ job.name }}</td>
            <td>
                <span class="badge badge-{{ job.state_text.lower() }}">
                    {{ job.state_text }}
                </span>
            </td>
            <td>{{ job.pages if job.pages > 0 else 'N/A' }}</td>
            <td>{{ (job.size / 1024)|round(2) }} MB</td>
            <td>{{ job.time }}</td>
            <td>
                <div class="action-buttons">
                    {% if job.state in [3, 4] %}
                    <button onclick="releaseJob({{ job.id }})" class="btn btn-success btn-small">
                        Release
                    </button>
                    {% endif %}
                    {% if job.state not in [7, 8, 9] %}
                    <button onclick="cancelJob({{ job.id }})" class="btn btn-danger btn-small">
                        Cancel
                    </button>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty-state">
    <div class="empty-state-icon">üìÑ</div>
    <h3>No print jobs</h3>
    <p>There are no jobs in the queue right now.</p>
</div>
{% endif %}

<div style="margin-top: 30px; padding: 20px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
    <h3 style="margin-bottom: 10px;">‚ö†Ô∏è Admin Mode</h3>
    <p style="color: #666;">You can manage all users' print jobs. Use this power responsibly!</p>
</div>

<script>
function releaseJob(jobId) {
    if (!confirm('Release this print job?')) return;
    
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<span class="loading"></span>';
    
    fetch(`/api/job/${jobId}/release`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Job released! Printing will start shortly.');
            location.reload();
        } else {
            alert('‚ùå Error: ' + data.error);
            button.disabled = false;
            button.innerHTML = 'Release';
        }
    })
    .catch(error => {
        alert('‚ùå Error: ' + error);
        button.disabled = false;
        button.innerHTML = 'Release';
    });
}

function cancelJob(jobId) {
    if (!confirm('Cancel this print job? This cannot be undone.')) return;
    
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<span class="loading"></span>';
    
    fetch(`/api/job/${jobId}/cancel`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Job canceled');
            location.reload();
        } else {
            alert('‚ùå Error: ' + data.error);
            button.disabled = false;
            button.innerHTML = 'Cancel';
        }
    })
    .catch(error => {
        alert('‚ùå Error: ' + error);
        button.disabled = false;
        button.innerHTML = 'Cancel';
    });
}
</script>
{% endblock %}
