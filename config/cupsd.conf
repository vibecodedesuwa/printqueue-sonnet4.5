# CUPS Configuration with AD Authentication
# Merged: read operations open, print operations require auth via policy

# Log level
LogLevel warn

# Administrator user group
SystemGroup lpadmin

# Listen on all interfaces
Port 631
Listen /var/run/cups/cups.sock

# Show shared printers on the local network
Browsing On
BrowseLocalProtocols dnssd

# Default authentication type
DefaultAuthType Basic

# Web interface setting
WebInterface Yes

# Restrict access to the server
<Location />
  Order allow,deny
  Allow @LOCAL
  Allow from 10.0.0.0/8
  Allow from 172.16.0.0/16
</Location>

# Restrict access to the admin pages
<Location /admin>
  Order allow,deny
  Allow @LOCAL
  Require user @SYSTEM
  AuthType Basic
</Location>

# Restrict access to configuration files
<Location /admin/conf>
  AuthType Basic
  Require user @SYSTEM
  Order allow,deny
  Allow @LOCAL
</Location>

# Printer access — NO auth here, auth is handled by the "authenticated" policy
# This allows pycups/lpstat to read job attributes freely
<Location /printers/es_non01_st515_01>
  Order allow,deny
  Allow @LOCAL
  Allow from 172.16.0.0/16
  Allow from 192.168.0.0/16
  Allow from 10.0.0.0/8
</Location>

# Default policy — no auth for reads, owner/admin for management
<Policy default>
  # Reading job/printer info — open access (needed by the web app)
  <Limit Get-Jobs Get-Job-Attributes Get-Printer-Attributes Get-Printers>
    Order deny,allow
    Allow all
  </Limit>

  # Job management — owner or admin
  <Limit Send-Document Send-URI Hold-Job Release-Job Restart-Job Purge-Jobs Set-Job-Attributes Create-Job-Subscription Renew-Subscription Cancel-Subscription Get-Notifications Reprocess-Job Cancel-Current-Job Suspend-Current-Job Resume-Job CUPS-Move-Job>
    Require user @OWNER @SYSTEM
    Order deny,allow
  </Limit>

  # Administration — system users only
  <Limit Pause-Printer Resume-Printer Set-Printer-Attributes Enable-Printer Disable-Printer Pause-Printer-After-Current-Job Hold-New-Jobs Release-Held-New-Jobs Deactivate-Printer Activate-Printer Restart-Printer Shutdown-Printer Startup-Printer Promote-Job Schedule-Job-After CUPS-Add-Printer CUPS-Delete-Printer CUPS-Add-Class CUPS-Delete-Class CUPS-Accept-Jobs CUPS-Reject-Jobs CUPS-Set-Default>
    AuthType Basic
    Require user @SYSTEM
    Order deny,allow
  </Limit>

  # Cancel/auth — owner or admin
  <Limit Cancel-Job CUPS-Authenticate-Job>
    Require user @OWNER @SYSTEM
    Order deny,allow
  </Limit>

  <Limit All>
    Order deny,allow
  </Limit>
</Policy>

# Authenticated policy — applies to the printer via lpadmin
# Requires AD/SSSD credentials to PRINT, but reading is open
<Policy authenticated>
  # Reading — open (so web app and lpstat can list jobs)
  <Limit Get-Jobs Get-Job-Attributes Get-Printer-Attributes Get-Printers>
    Order deny,allow
    Allow all
  </Limit>

  # Printing — requires AD credentials (AirPrint/IPP users authenticate here)
  <Limit Create-Job Print-Job Print-URI>
    AuthType Basic
    Require valid-user
    Order deny,allow
  </Limit>

  # Job management — owner or admin
  <Limit Send-Document Send-URI Hold-Job Release-Job Restart-Job Purge-Jobs Set-Job-Attributes Create-Job-Subscription Renew-Subscription Cancel-Subscription Get-Notifications Reprocess-Job Cancel-Current-Job Suspend-Current-Job Resume-Job CUPS-Move-Job>
    AuthType Basic
    Require user @OWNER @SYSTEM
    Order deny,allow
  </Limit>

  # Cancel/auth — owner or admin
  <Limit Cancel-Job CUPS-Authenticate-Job>
    AuthType Basic
    Require user @OWNER @SYSTEM
    Order deny,allow
  </Limit>

  <Limit All>
    Order deny,allow
  </Limit>
</Policy>
