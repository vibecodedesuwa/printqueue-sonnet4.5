{% extends "base.html" %}
{% block title %}Admin â€” PrintQ{% endblock %}

{% block content %}
<!-- Navigation -->
<ul class="nav nav-pills mb-3">
    <li class="nav-item"><a class="nav-link" href="{{ url_for('web.dashboard') }}"><i class="bi bi-grid me-1"></i>Dashboard</a></li>
    <li class="nav-item"><a class="nav-link active" href="{{ url_for('web.admin') }}"><i class="bi bi-gear me-1"></i>Admin</a></li>
    <li class="nav-item"><a class="nav-link" href="{{ url_for('web.kiosk_login') }}"><i class="bi bi-phone me-1"></i>Kiosk</a></li>
    <li class="nav-item"><a class="nav-link" href="{{ url_for('web.api_docs') }}"><i class="bi bi-book me-1"></i>API</a></li>
</ul>

<!-- Sub Tabs -->
<ul class="nav nav-pills nav-fill mb-3" id="adminTabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-jobs"><i class="bi bi-printer me-1"></i>All Jobs</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-apikeys"><i class="bi bi-key me-1"></i>API Keys</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-devices"><i class="bi bi-phone me-1"></i>Devices</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-emails"><i class="bi bi-envelope me-1"></i>Emails</button></li>
</ul>

<div class="tab-content">

<!-- â•â•â• Jobs Tab â•â•â• -->
<div class="tab-pane fade show active" id="tab-jobs">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0 fw-semibold"><i class="bi bi-list-ul me-1"></i>All Print Jobs <span class="count-badge" id="adminJobsCount">0</span></h6>
        <span class="live-indicator"><span class="live-dot"></span> Live</span>
    </div>

    <div class="table-responsive-wrapper">
        <table class="table table-hover mb-0">
            <thead><tr><th>ID</th><th>User</th><th>Document</th><th>Status</th><th>Pages</th><th>Size</th><th>Time</th><th>Actions</th></tr></thead>
            <tbody id="adminJobsTableBody"></tbody>
        </table>
    </div>
    <div class="job-cards" id="adminJobsCards"></div>
    <div class="empty-state" id="adminJobsEmpty" style="display:none;">
        <div class="empty-state-icon">ğŸ“‹</div>
        <h6 class="text-body-secondary">No jobs in queue</h6>
    </div>
</div>

<!-- â•â•â• API Keys Tab â•â•â• -->
<div class="tab-pane fade" id="tab-apikeys">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0 fw-semibold"><i class="bi bi-key me-1"></i>API Keys</h6>
        <button class="btn btn-primary btn-sm" onclick="document.getElementById('newKeyForm').classList.toggle('d-none')"><i class="bi bi-plus-lg me-1"></i>New Key</button>
    </div>

    <!-- New Key Form -->
    <div id="newKeyForm" class="card p-3 mb-3 d-none">
        <div class="row g-2 mb-2">
            <div class="col-md-6">
                <label class="form-label">Key Name</label>
                <input id="keyName" type="text" class="form-control form-control-sm" placeholder="e.g. Mobile App">
            </div>
            <div class="col-md-6">
                <label class="form-label">Owner</label>
                <input id="keyOwner" type="text" class="form-control form-control-sm" value="{{ user.username }}">
            </div>
        </div>
        <div class="mb-2">
            <label class="form-label">Permissions</label>
            <div class="d-flex gap-3">
                <div class="form-check"><input type="checkbox" class="form-check-input" id="permRead" checked><label class="form-check-label" for="permRead">Read</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" id="permWrite"><label class="form-check-label" for="permWrite">Write</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" id="permAdmin"><label class="form-check-label" for="permAdmin">Admin</label></div>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm" onclick="submitApiKey()"><i class="bi bi-check-lg me-1"></i>Create</button>
            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('newKeyForm').classList.add('d-none')">Cancel</button>
        </div>
    </div>

    <!-- Key Result -->
    <div id="newKeyResult" class="alert alert-success d-none" role="alert">
        <strong><i class="bi bi-check-circle me-1"></i>Key created!</strong> Copy it now â€” it won't be shown again:
        <code id="newKeyValue" class="d-block mt-2 p-2 bg-dark rounded" style="user-select: all; word-break: break-all;"></code>
    </div>

    {% if api_keys %}
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead><tr><th>Prefix</th><th>Name</th><th>Owner</th><th>Permissions</th><th>Created</th><th>Last Used</th><th>Requests</th><th>Actions</th></tr></thead>
            <tbody>
                {% for key in api_keys %}
                <tr>
                    <td><code>{{ key.key_prefix }}...</code></td>
                    <td>{{ key.name }}</td>
                    <td>{{ key.owner }}</td>
                    <td>{{ key.permissions }}</td>
                    <td><small class="text-body-tertiary">{{ key.created_at }}</small></td>
                    <td><small class="text-body-tertiary">{{ key.last_used or 'Never' }}</small></td>
                    <td>{{ key.request_count }}</td>
                    <td>
                        {% if key.is_active %}
                        <button onclick="revokeKey({{ key.id }})" class="btn btn-danger btn-sm"><i class="bi bi-x-lg"></i></button>
                        {% else %}
                        <span class="badge bg-danger bg-opacity-25 text-danger">Revoked</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ”‘</div>
        <h6 class="text-body-secondary">No API keys</h6>
        <p class="text-body-tertiary" style="font-size: 13px;">Create one to use the REST API</p>
    </div>
    {% endif %}
</div>

<!-- â•â•â• Devices Tab â•â•â• -->
<div class="tab-pane fade" id="tab-devices">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0 fw-semibold"><i class="bi bi-phone me-1"></i>Device Mapping</h6>
        <button class="btn btn-primary btn-sm" onclick="document.getElementById('addDeviceForm').classList.toggle('d-none')"><i class="bi bi-plus-lg me-1"></i>Add</button>
    </div>
    <p class="text-body-tertiary mb-3" style="font-size: 13px;">Map CUPS usernames from AirPrint/Mopria devices to real users.</p>

    <div id="addDeviceForm" class="card p-3 mb-3 d-none">
        <div class="row g-2 align-items-end">
            <div class="col">
                <label class="form-label">CUPS Username (e.g. "iPhone")</label>
                <input id="devCupsUser" type="text" class="form-control form-control-sm">
            </div>
            <div class="col">
                <label class="form-label">Authentik Username</label>
                <input id="devAuthUser" type="text" class="form-control form-control-sm">
            </div>
            <div class="col-auto"><button class="btn btn-success btn-sm" onclick="addDevice()"><i class="bi bi-check-lg"></i></button></div>
        </div>
    </div>

    {% if known_devices %}
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead><tr><th>CUPS Username</th><th>â†’ Authentik User</th><th>Auto</th><th>Actions</th></tr></thead>
            <tbody>
                {% for dev in known_devices %}
                <tr>
                    <td><code>{{ dev.cups_username }}</code></td>
                    <td>{{ dev.authentik_username }}</td>
                    <td>{{ 'âœ…' if dev.auto_match else 'âŒ' }}</td>
                    <td><button onclick="deleteDevice({{ dev.id }})" class="btn btn-danger btn-sm"><i class="bi bi-trash"></i></button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ“±</div>
        <h6 class="text-body-secondary">No device mappings</h6>
        <p class="text-body-tertiary" style="font-size: 13px;">AirPrint/Mopria jobs will appear as unclaimed until mapped</p>
    </div>
    {% endif %}
</div>

<!-- â•â•â• Emails Tab â•â•â• -->
<div class="tab-pane fade" id="tab-emails">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0 fw-semibold"><i class="bi bi-envelope me-1"></i>Email Mapping</h6>
        <button class="btn btn-primary btn-sm" onclick="document.getElementById('addEmailForm').classList.toggle('d-none')"><i class="bi bi-plus-lg me-1"></i>Add</button>
    </div>
    <p class="text-body-tertiary mb-3" style="font-size: 13px;">Map email addresses to usernames for print-via-email.</p>

    <div id="addEmailForm" class="card p-3 mb-3 d-none">
        <div class="row g-2 align-items-end">
            <div class="col">
                <label class="form-label">Email Address</label>
                <input id="mapEmail" type="email" class="form-control form-control-sm">
            </div>
            <div class="col">
                <label class="form-label">Username</label>
                <input id="mapUser" type="text" class="form-control form-control-sm">
            </div>
            <div class="col-auto"><button class="btn btn-success btn-sm" onclick="addEmail()"><i class="bi bi-check-lg"></i></button></div>
        </div>
    </div>

    {% if email_mappings %}
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead><tr><th>Email Address</th><th>â†’ Username</th><th>Actions</th></tr></thead>
            <tbody>
                {% for em in email_mappings %}
                <tr>
                    <td>{{ em.email }}</td>
                    <td>{{ em.username }}</td>
                    <td><button onclick="deleteEmail('{{ em.email }}')" class="btn btn-danger btn-sm"><i class="bi bi-trash"></i></button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ“§</div>
        <h6 class="text-body-secondary">No email mappings</h6>
        <p class="text-body-tertiary" style="font-size: 13px;">Map email addresses to usernames</p>
    </div>
    {% endif %}
</div>

</div><!-- /tab-content -->
{% endblock %}

{% block extra_js %}
<script>
    const POLL_INTERVAL = 5000;
    let prevAdminJobIds = new Set();

    // â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function badgeHtml(stateText) {
        const map = { held: 'primary', pending: 'warning', processing: 'success', completed: 'secondary', canceled: 'danger' };
        const cls = map[(stateText || '').toLowerCase()] || 'secondary';
        return `<span class="badge bg-${cls} bg-opacity-25 text-${cls}">${stateText}</span>`;
    }

    function renderAdminRow(job, isNew) {
        let acts = '';
        if ([3,4].includes(job.state)) acts += `<button onclick="releaseJob(${job.id})" class="btn btn-success btn-sm"><i class="bi bi-check-lg"></i></button>`;
        if (![7,8,9].includes(job.state)) acts += `<button onclick="cancelJob(${job.id})" class="btn btn-danger btn-sm ms-1"><i class="bi bi-x-lg"></i></button>`;
        return `<tr class="${isNew ? 'fade-in' : ''}" data-job-id="${job.id}">
            <td><strong>#${job.id}</strong></td>
            <td>${job.user || 'Unknown'}</td>
            <td class="text-truncate" style="max-width: 180px;">${job.name || 'Untitled'}</td>
            <td>${badgeHtml(job.state_text)}</td>
            <td>${job.pages > 0 ? job.pages : 'â€”'}</td>
            <td>${job.size} KB</td>
            <td><small class="text-body-tertiary">${job.time}</small></td>
            <td>${acts}</td>
        </tr>`;
    }

    function renderAdminCard(job, isNew) {
        let acts = '';
        if ([3,4].includes(job.state)) acts += `<button onclick="releaseJob(${job.id})" class="btn btn-success btn-sm"><i class="bi bi-check-lg me-1"></i>Release</button>`;
        if (![7,8,9].includes(job.state)) acts += `<button onclick="cancelJob(${job.id})" class="btn btn-danger btn-sm"><i class="bi bi-x-lg me-1"></i>Cancel</button>`;
        return `<div class="job-card ${isNew ? 'fade-in' : ''}" data-job-id="${job.id}">
            <div class="job-card-header">
                <span class="job-card-title">#${job.id} â€” ${job.name || 'Untitled'}</span>
                ${badgeHtml(job.state_text)}
            </div>
            <div class="job-card-meta">
                <span><i class="bi bi-person"></i> ${job.user || 'Unknown'}</span>
                <span><i class="bi bi-file-earmark"></i> ${job.pages > 0 ? job.pages : 'â€”'} pg</span>
                <span><i class="bi bi-hdd"></i> ${job.size} KB</span>
                <span><i class="bi bi-clock"></i> ${job.time}</span>
            </div>
            <div class="job-card-actions">${acts}</div>
        </div>`;
    }

    // â”€â”€â”€ Update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateAdminJobs(jobs) {
        const newIds = new Set(jobs.map(j => j.id));
        document.getElementById('adminJobsCount').textContent = jobs.length;
        const empty = document.getElementById('adminJobsEmpty');
        if (jobs.length === 0) {
            document.getElementById('adminJobsTableBody').innerHTML = '';
            document.getElementById('adminJobsCards').innerHTML = '';
            empty.style.display = 'block';
        } else {
            empty.style.display = 'none';
            document.getElementById('adminJobsTableBody').innerHTML = jobs.map(j => renderAdminRow(j, !prevAdminJobIds.has(j.id))).join('');
            document.getElementById('adminJobsCards').innerHTML = jobs.map(j => renderAdminCard(j, !prevAdminJobIds.has(j.id))).join('');
        }
        prevAdminJobIds = newIds;
    }

    function refreshAdminJobs() {
        fetch('{{ url_for("web.api_jobs") }}?all=true')
            .then(r => r.json()).then(updateAdminJobs).catch(console.error);
    }

    refreshAdminJobs();
    setInterval(refreshAdminJobs, POLL_INTERVAL);

    // â”€â”€â”€ Job Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function releaseJob(jobId) {
        const ok = await confirmAction({ title: 'Release Job', message: `Release job #${jobId}?`, confirmText: 'Release', type: 'success' });
        if (!ok) return;
        try {
            const r = await fetch(`/api/job/${jobId}/release`, { method: 'POST' });
            const d = await r.json();
            if (d.success) { Toast.success('Job released'); refreshAdminJobs(); } else Toast.error(d.error);
        } catch (e) { Toast.error('Error: ' + e.message); }
    }

    async function cancelJob(jobId) {
        const ok = await confirmAction({ title: 'Cancel Job', message: `Cancel job #${jobId}? This cannot be undone.`, confirmText: 'Cancel Job', type: 'danger' });
        if (!ok) return;
        try {
            const r = await fetch(`/api/job/${jobId}/cancel`, { method: 'POST' });
            const d = await r.json();
            if (d.success) { Toast.success('Job cancelled'); refreshAdminJobs(); } else Toast.error(d.error);
        } catch (e) { Toast.error('Error: ' + e.message); }
    }

    // â”€â”€â”€ API Keys â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function submitApiKey() {
        const name = document.getElementById('keyName').value;
        const owner = document.getElementById('keyOwner').value;
        const permissions = [];
        if (document.getElementById('permRead').checked) permissions.push('read');
        if (document.getElementById('permWrite').checked) permissions.push('write');
        if (document.getElementById('permAdmin').checked) permissions.push('admin');
        if (!name) { Toast.warning('Key name is required'); return; }

        try {
            const r = await fetch('/api/v1/keys', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer session' },
                body: JSON.stringify({ name, owner, permissions })
            });
            const data = await r.json();
            if (data.key) {
                document.getElementById('newKeyForm').classList.add('d-none');
                document.getElementById('newKeyResult').classList.remove('d-none');
                document.getElementById('newKeyValue').textContent = data.key;
                Toast.success('API key created!');
            } else {
                Toast.error(data.error || 'Failed to create key');
            }
        } catch (e) { Toast.error('Error: ' + e.message); }
    }

    async function revokeKey(keyId) {
        const ok = await confirmAction({ title: 'Revoke Key', message: 'Revoke this API key? It will stop working immediately.', confirmText: 'Revoke', type: 'danger' });
        if (!ok) return;
        try {
            await fetch(`/api/v1/keys/${keyId}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer session' } });
            Toast.success('Key revoked');
            location.reload();
        } catch (e) { Toast.error('Error: ' + e.message); }
    }

    // â”€â”€â”€ Device Mapping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function addDevice() {
        const cups = document.getElementById('devCupsUser').value;
        const auth = document.getElementById('devAuthUser').value;
        if (!cups || !auth) { Toast.warning('Both fields are required'); return; }
        try {
            await fetch('/api/v1/devices', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ cups_username: cups, authentik_username: auth }) });
            Toast.success('Device mapping added');
            location.reload();
        } catch (e) { Toast.error('Error: ' + e.message); }
    }

    async function deleteDevice(id) {
        const ok = await confirmAction({ title: 'Delete Mapping', message: 'Delete this device mapping?', confirmText: 'Delete', type: 'danger' });
        if (!ok) return;
        try {
            await fetch(`/api/v1/devices/${id}`, { method: 'DELETE' });
            Toast.success('Mapping deleted');
            location.reload();
        } catch (e) { Toast.error('Error: ' + e.message); }
    }

    // â”€â”€â”€ Email Mapping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function addEmail() {
        const email = document.getElementById('mapEmail').value;
        const user = document.getElementById('mapUser').value;
        if (!email || !user) { Toast.warning('Both fields are required'); return; }
        try {
            await fetch('/api/v1/emails', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, username: user }) });
            Toast.success('Email mapping added');
            location.reload();
        } catch (e) { Toast.error('Error: ' + e.message); }
    }

    async function deleteEmail(email) {
        const ok = await confirmAction({ title: 'Delete Mapping', message: `Delete mapping for ${email}?`, confirmText: 'Delete', type: 'danger' });
        if (!ok) return;
        try {
            await fetch(`/api/v1/emails/${encodeURIComponent(email)}`, { method: 'DELETE' });
            Toast.success('Mapping deleted');
            location.reload();
        } catch (e) { Toast.error('Error: ' + e.message); }
    }
</script>
{% endblock %}
