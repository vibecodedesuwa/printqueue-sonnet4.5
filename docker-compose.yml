version: "3.8"

services:
  print-queue-manager:
    build: .
    container_name: print-queue-manager
    restart: unless-stopped
    ports:
      - "5000:5000"
    volumes:
      - ./data:/app/data
      - /var/run/cups/cups.sock:/var/run/cups/cups.sock
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - AUTHENTIK_CLIENT_ID=${AUTHENTIK_CLIENT_ID}
      - AUTHENTIK_CLIENT_SECRET=${AUTHENTIK_CLIENT_SECRET}
      - AUTHENTIK_METADATA_URL=${AUTHENTIK_METADATA_URL}
      - PRINTER_NAME=${PRINTER_NAME:-HP_Smart_Tank_515}
      - ADMIN_GROUPS=${ADMIN_GROUPS:-admins,print-admins}
      - ADMIN_USERS=${ADMIN_USERS:-admin}
      - DATABASE_PATH=data/printqueue.db
      - UPLOAD_FOLDER=data/uploads
      # Email Print (optional)
      - MAIL_ENABLED=${MAIL_ENABLED:-false}
      - MAIL_IMAP_HOST=${MAIL_IMAP_HOST:-}
      - MAIL_IMAP_PORT=${MAIL_IMAP_PORT:-993}
      - MAIL_IMAP_USER=${MAIL_IMAP_USER:-}
      - MAIL_IMAP_PASS=${MAIL_IMAP_PASS:-}
      - MAIL_IMAP_FOLDER=${MAIL_IMAP_FOLDER:-INBOX}
      - MAIL_SMTP_HOST=${MAIL_SMTP_HOST:-}
      - MAIL_SMTP_PORT=${MAIL_SMTP_PORT:-587}
      - MAIL_SMTP_USER=${MAIL_SMTP_USER:-}
      - MAIL_SMTP_PASS=${MAIL_SMTP_PASS:-}
      # Claim system
      - UNCLAIMED_JOB_TIMEOUT=${UNCLAIMED_JOB_TIMEOUT:-24}
    depends_on:
      - cups
    networks:
      - print-network

  cups:
    image: olbat/cupsd:latest
    container_name: cups-server
    restart: unless-stopped
    ports:
      - "631:631"
      - "5353:5353/udp" # mDNS for AirPrint/Mopria discovery
    volumes:
      - cups-data:/etc/cups
      - ./ppd:/usr/share/cups/model
      - ./config/avahi:/etc/avahi/services # AirPrint service files
    environment:
      - CUPSADMIN=admin
      - CUPSPASSWORD=changeme
    networks:
      - print-network
    privileged: true

volumes:
  cups-data:

networks:
  print-network:
    driver: bridge
